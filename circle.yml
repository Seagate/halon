machine:
  services:
    - docker
  environment:
    STACK_FLAGS: --no-terminal --docker-persist --docker-mount $HOME/halon/vendor/mero:/mero

checkout:
  post:
    - git submodule sync
    # No need to prune git history using --depth, because circleci caches git.
    - git submodule update --init
    - cd vendor/mero; git submodule init
    - cd vendor/mero; git config submodule.extra-libs/galois.url git@github.com:tweag/mero-galois
    - cd vendor/mero; git config submodule.extra-libs/gf-complete.url git@github.com:tweag/mero-gf-complete
    - cd vendor/mero; git config submodule.extra-libs/yaml.url git@github.com:tweag/mero-yaml
    - cd vendor/mero; git submodule update

dependencies:
  pre:
    - curl -LO https://github.com/commercialhaskell/stack/releases/download/v0.1.8.0/stack-0.1.8.0-linux-x86_64.tar.gz
    - tar xf stack-0.1.8.0-linux-x86_64.tar.gz
    - mkdir -p ~/.local/bin
    - cp stack-0.1.8.0-linux-x86_64/stack ~/.local/bin
  override:
    - echo | stack $STACK_FLAGS --docker-registry-username $DOCKER_REGISTRY_USERNAME --docker-registry-password $DOCKER_REGISTRY_PASSWORD docker pull
    - stack $STACK_FLAGS setup
    # Build Mero.
    - cd vendor/mero; stack $STACK_FLAGS exec -- ./autogen.sh
    - cd vendor/mero; stack $STACK_FLAGS exec -- ./configure '--with-linux=/usr/src/kernels/*/'
    - cd vendor/mero; stack $STACK_FLAGS exec -- make
    # Build stack-managed halon dependencies.
    - stack $STACK_FLAGS build --only-snapshot --prefetch --test --bench

  cache_directories:
    - ~/.stack/

test:
  override:
    # Build with USE_MERO and then without.
    - stack $STACK_FLAGS build --test --no-run-tests --flag rpclite:mero --flag mero-halon:mero
    - stack $STACK_FLAGS build --test --no-run-tests
    # Only test mero-halon and deps, without USE_MERO.
    - stack $STACK_FLAGS build --test mero-halon:
        timeout: 3600
