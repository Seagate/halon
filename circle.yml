machine:
  services:
    - docker
  environment:
      # Use only as many jobs as CPUs are available (via cpuset)
      STACK_FLAGS: --no-terminal --docker-persist --docker-mount $HOME/halon/vendor/mero:/mero --jobs 2

checkout:
  post:
    # remove cached submodules - otherwise interference ensues when updating submodule urls
    - rm -rf .git/modules/*
    - git submodule sync
    # No need to prune git history using --depth, because circleci caches git.
    - git submodule update --init --recursive

dependencies:
  pre:
    - mkdir -p ~/.local/bin
    - curl -L https://www.stackage.org/stack/linux-x86_64 | tar xz --wildcards --strip-components=1 -C ~/.local/bin '*/stack';
    - stack --version
    - sudo apt-get install socat sysstat
    # Make the docker socket available on a port.
    - "socat TCP-LISTEN:5555,reuseaddr,fork UNIX-CLIENT:/var/run/docker.sock":
        background: true
    # Show the current cpuset mask for analysis of stats
    - grep Cpus_a "/proc/$$/status"
  override:
    # Build tweagremote image for distributed tests and copy the ssh key to access it.
    - docker build --tag=tweagremote docker/tweagremote
    - echo | stack $STACK_FLAGS --docker-registry-username $DOCKER_REGISTRY_USERNAME --docker-registry-password $DOCKER_REGISTRY_PASSWORD docker pull
    - stack $STACK_FLAGS setup
    # Build Mero.
    - cd vendor/mero; stack $STACK_FLAGS exec -- ./autogen.sh
    - cd vendor/mero; stack $STACK_FLAGS exec -- ./configure '--with-linux=/usr/src/kernels/*/'
    - cd vendor/mero; stack $STACK_FLAGS exec -- make
    # Build stack-managed halon dependencies.
    - stack $STACK_FLAGS build --only-snapshot --prefetch --test --bench
    - stack $STACK_FLAGS exec bash -- -c 'mkdir ~/.ssh; cp -v docker/tweagremote/id_rsa ~/.ssh/ && chmod go-rwx ~/.ssh/id_rsa'

  cache_directories:
    - ~/.stack/

test:
  override:
    - "top -b -d 5 | grep -A 10 'PID USER' &> topten-stats.log":
        background: true
    - "pidstat -C 'mero|distributed|random|integration|test|halond' -du 5 &> pidstats-tests.log":
        background: true
    - "mpstat -P ON 5 &> mpstats.log":
        background: true
    - "iostat -dNtxzm 5 &> iostats.log":
        background: true
    # Build with USE_MERO and then without.
    - stack $STACK_FLAGS build --test --no-run-tests --flag mero-halon:mero --haddock --no-haddock-deps
    - stack $STACK_FLAGS build --flag mero-halon:distributed-tests --test --no-run-tests --haddock --no-haddock-deps
    # Only test mero-halon and deps, without USE_MERO.
    # Testing with USE_MERO is not possible since m0_init fails when some cpus
    # on the host are forbidden via cpusets as circleci does.
    - stack $STACK_FLAGS --docker-env DC_PROVIDER=docker --docker-env DOCKER_HOST=http://172.17.42.1:5555 --docker-env DC_HOST_IP=172.17.42.1 --docker-env HALON_TRACING='consensus-paxos replicated-log EQ EQ.producer MM RS RG call startup' build --flag mero-halon:distributed-tests --haddock --no-haddock-deps --test:
        timeout: 3600
    - scripts/copy_artifacts.sh "${CIRCLE_ARTIFACTS}"
