machine:
  services:
    - docker
  environment:
      # Use only as many jobs as CPUs are available (via cpuset)
      STACK_FLAGS: "--docker-env LANG=en_US.utf8 --docker-env PKG_CONFIG_PATH=/mero --no-terminal --docker-persist --docker-mount $HOME/halon/vendor/mero:/mero --jobs 2"
      STACK_TEST_FLAGS: "--docker-env LANG=en_US.utf8 --docker-env PKG_CONFIG_PATH=/mero --docker-env DC_PROVIDER=docker --docker-env DOCKER_HOST=http://$(ip addr ls docker0 | awk '/inet / {print $2}' | cut -d'/' -f1):5555 --docker-env DC_HOST_IP=$(ip addr ls docker0 | awk '/inet / {print $2}' | cut -d'/' -f1) --docker-env TASTY_PATTERN=![require-mero]"
      TMPDIR: .

checkout:
  pre:
    # We move the halon folder to ram to prevent tests from failing when the
    # disk of the test box is slow (out of our control).
    - mv halon halon2 && mkdir halon && sudo mount -t tmpfs -o size=4096m tmpfs halon && cp -r halon2/. halon && sudo chown -R $USER halon
  post:
    # remove cached submodules - otherwise interference ensues when updating submodule urls
    - rm -rf .git/modules/*
    - git submodule sync
    # No need to prune git history using --depth, because circleci caches git.
    - git submodule update --init --recursive

dependencies:
  pre:
    - mkdir -p ~/.local/bin
    - curl -L https://www.stackage.org/stack/linux-x86_64 | tar xz --wildcards --strip-components=1 -C ~/.local/bin '*/stack';
    - stack --version
    - sudo apt-get install socat sysstat
    # Make the docker socket available on a port.
    - "socat TCP-LISTEN:5555,reuseaddr,fork UNIX-CLIENT:/var/run/docker.sock":
        background: true
    # Show the current cpuset mask for analysis of stats
    - grep Cpus_a "/proc/$$/status"
  override:
    # Build tweagremote image for distributed tests and copy the ssh key to access it.
    - docker build --tag=tweagremote docker/tweagremote
    # For future debug purposes
    - echo $STACK_FLAGS
    - echo $STACK_TEST_FLAGS
    - echo | stack $STACK_FLAGS --docker-registry-username $DOCKER_REGISTRY_USERNAME --docker-registry-password $DOCKER_REGISTRY_PASSWORD docker pull
    - stack $STACK_FLAGS setup
    # Build Mero.
    - cd vendor/mero; stack $STACK_FLAGS exec -- ./autogen.sh
    - cd vendor/mero; stack $STACK_FLAGS exec -- ./configure '--with-linux=/usr/src/kernels/*/'
    - cd vendor/mero; stack $STACK_FLAGS exec -- make
    # Build stack-managed halon dependencies.
    - stack $STACK_FLAGS build --only-snapshot --prefetch --test --bench
    - stack $STACK_FLAGS exec bash -- -c 'mkdir ~/.ssh; cp -v docker/tweagremote/id_rsa ~/.ssh/ && chmod go-rwx ~/.ssh/id_rsa'

  cache_directories:
    - ~/.stack/

test:
  override:
    - "cp scripts/toprc ~/.toprc; stdbuf -oL -eL top -b -d 5 | stdbuf -oL -eL grep -A 10 'PID USER' &>> topten-stats.log & while (true) do { stdbuf -oL -eL date --utc && sleep 5 || break; } done &>> topten-stats.log":
        background: true
    - "pidstat -rdu 5 &> pidstats-tests.log":
        background: true
    - "mpstat -P ON 5 &> mpstats.log":
        background: true
    - "iostat -dNtxzm 5 &> iostats.log":
        background: true
    # Build with USE_MERO and then without.
    - stack $STACK_FLAGS build --test --no-run-tests --flag mero-halon:mero --haddock --no-haddock-deps
    - stack $STACK_FLAGS build --flag mero-halon:distributed-tests --test --no-run-tests --haddock --no-haddock-deps
    - stack $STACK_FLAGS $STACK_TEST_FLAGS --docker-env HALON_TRACING='consensus-paxos replicated-log EQ EQ.producer MM RS RG call startup' build --flag mero-halon:distributed-tests replicated-log:tests halon:tests mero-halon:tests:
        timeout: 3600
    - stack $STACK_FLAGS $STACK_TEST_FLAGS --docker-env HALON_TRACING='consensus-paxos replicated-log EQ EQ.producer MM RS RG call startup' build --flag mero-halon:distributed-tests replicated-log:random replicated-log:scheduler-tests halon:scheduler-tests mero-halon:scheduler-tests:
        timeout: 3600
    # scp fails in distributed tests unless we restrict permissions on the config file.
    - chmod 600 .stack-work/docker/_home/.ssh/config; stack $STACK_FLAGS $STACK_TEST_FLAGS build --flag mero-halon:distributed-tests mero-halon:distributed-tests:
        timeout: 3600
    - scripts/copy_artifacts.sh "${CIRCLE_ARTIFACTS}"

deployment:
  # this deployment script will trigger the castor integration tests
  # on the latest refs of the components.
  autobuild:
    branch: master
    commands:
      - bash ci/autobuild.sh
