machine:
  services:
    - docker
  environment:
    STACK_FLAGS: --no-terminal --docker-mount /vagrant/vendor/mero:/mero
    # To pickup rmt script.
    PATH: ci:$PATH

checkout:
  post:
    - git submodule sync
    # No need to prune git history using --depth, because circleci caches git.
    - git submodule update --init
    - cd vendor/mero; git submodule init
    - cd vendor/mero; git config submodule.extra-libs/galois.url git@github.com:tweag/mero-galois
    - cd vendor/mero; git config submodule.extra-libs/gf-complete.url git@github.com:tweag/mero-gf-complete
    - cd vendor/mero; git config submodule.extra-libs/yaml.url git@github.com:tweag/mero-yaml
    - cd vendor/mero; git submodule update

dependencies:
  pre:
    - curl https://releases.hashicorp.com/vagrant/1.7.4/vagrant_1.7.4_x86_64.deb > /tmp/vagrant.deb
    - sudo dpkg -i /tmp/vagrant.deb
    - vagrant plugin install vagrant-aws
    - vagrant up --provider=aws
    - vagrant ssh-config --host aws > ssh.config
    # Safety hatch: self destruct instance after 1h if still alive.
    - rmt . "echo sudo halt | at now + 1 hour"
    # Manually restore cache on remote machine.
    - rsync -az --delete -e "ssh -F ssh.config" ~/.stack/ aws:.stack/ || true
  override:
    - rmt . stack $STACK_FLAGS --docker-registry-username $DOCKER_REGISTRY_USERNAME --docker-registry-password $DOCKER_REGISTRY_PASSWORD docker pull
    - rmt . stack $STACK_FLAGS setup
    # Build Mero.
    - rmt vendor/mero stack $STACK_FLAGS exec -- ./autogen.sh
    - rmt vendor/mero stack $STACK_FLAGS exec -- ./configure '--with-linux=/usr/src/kernels/*/'
    - rmt vendor/mero stack $STACK_FLAGS exec -- make -j4
    # Build stack-managed halon dependencies.
    - rmt . stack $STACK_FLAGS build --only-snapshot --prefetch --test --bench
  post:
    # Save cache.
    - rsync -az --delete -e "ssh -F ssh.config" aws:.stack/ ~/.stack/ || true

  cache_directories:
    - ~/.stack/

test:
  override:
    # Keep going on failure to emulate default CircleCI.

    # Build with USE_MERO and then without.
    - rmt -k . stack $STACK_FLAGS build --test --no-run-tests --flag mero-halon:mero
    - rmt -k . stack $STACK_FLAGS build --test --no-run-tests
    # Only test mero-halon and deps, without USE_MERO.
    - rmt -k . stack $STACK_FLAGS --docker-env HALON_TRACING='"consensus-paxos replicated-log EQ EQ.producer RS"' test:
        timeout: 3600
    - scripts/circleci_copy_artifacts.sh
  post:
    - vagrant destroy -f
