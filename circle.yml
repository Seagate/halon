machine:
  services:
    - docker
  environment:
      STACK_FLAGS: --no-terminal --docker-persist --docker-mount $HOME/halon/vendor/mero:/mero

checkout:
  post:
    - git submodule sync
    # No need to prune git history using --depth, because circleci caches git.
    - git submodule update --init
    - cd vendor/mero; git submodule init
    - cd vendor/mero; git config submodule.extra-libs/galois.url git@github.com:tweag/mero-galois
    - cd vendor/mero; git config submodule.extra-libs/gf-complete.url git@github.com:tweag/mero-gf-complete
    - cd vendor/mero; git config submodule.extra-libs/yaml.url git@github.com:tweag/mero-yaml
    - cd vendor/mero; git submodule update

dependencies:
  pre:
    - curl -LO https://github.com/commercialhaskell/stack/releases/download/v0.1.8.0/stack-0.1.8.0-linux-x86_64.tar.gz
    - tar xf stack-0.1.8.0-linux-x86_64.tar.gz
    - mkdir -p ~/.local/bin
    - cp stack-0.1.8.0-linux-x86_64/stack ~/.local/bin
    - sudo apt-get install socat
    # Make the docker socket available on a port.
    - "socat TCP-LISTEN:5555,reuseaddr,fork UNIX-CLIENT:/var/run/docker.sock":
        background: true
  override:
    - echo | stack $STACK_FLAGS --docker-registry-username $DOCKER_REGISTRY_USERNAME --docker-registry-password $DOCKER_REGISTRY_PASSWORD docker pull
    - stack $STACK_FLAGS setup
    # Build Mero.
    - cd vendor/mero; stack $STACK_FLAGS exec -- ./autogen.sh
    - cd vendor/mero; stack $STACK_FLAGS exec -- ./configure '--with-linux=/usr/src/kernels/*/'
    - cd vendor/mero; stack $STACK_FLAGS exec -- make
    # Build stack-managed halon dependencies.
    - stack $STACK_FLAGS build --only-snapshot --prefetch --test --bench
    # Build tweagremote image for distributed tests and copy the ssh key to access it.
    - docker build --tag=tweagremote docker/tweagremote
    - stack $STACK_FLAGS exec bash -- -c 'mkdir ~/.ssh; cp -v docker/tweagremote/id_rsa ~/.ssh/ && chmod go-rwx ~/.ssh/id_rsa'

  cache_directories:
    - ~/.stack/

test:
  override:
    # Build with USE_MERO and then without.
    - stack $STACK_FLAGS build --test --no-run-tests --flag mero-halon:mero --haddock --no-haddock-deps
    - stack $STACK_FLAGS build --flag mero-halon:distributed-tests --test --no-run-tests --haddock --no-haddock-deps
    # Only test mero-halon and deps, without USE_MERO.
    - stack $STACK_FLAGS --docker-env DC_PROVIDER=docker --docker-env DOCKER_HOST=http://172.17.42.1:5555 --docker-env DC_HOST_IP=172.17.42.1 --docker-env HALON_TRACING='consensus-paxos replicated-log EQ EQ.producer MM RS RG' build --flag mero-halon:distributed-tests --haddock --no-haddock-deps --test:
        timeout: 3600
    - scripts/circleci_copy_artifacts.sh
